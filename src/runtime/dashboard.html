<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Bot ‚Äî Command Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            surface: '#0f172a',
            card: '#1e293b',
            cardHover: '#334155',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  </style>
</head>
<body class="bg-surface text-slate-200 min-h-screen">
  
  <!-- Header -->
  <header class="bg-card border-b border-slate-700 px-6 py-3 flex items-center justify-between sticky top-0 z-50">
    <div class="flex items-center gap-4">
      <h1 class="text-lg font-bold text-white">‚ö° Polymarket Bot</h1>
      <span id="runner-badge" class="text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 mono">prod</span>
      <span id="trading-mode" class="text-xs px-2 py-0.5 rounded-full mono">paper</span>
      <span id="build" class="text-xs text-slate-500 mono"></span>
    </div>
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2" id="semaphores">
        <div class="flex items-center gap-1" title="Loop">
          <span class="text-xs text-slate-400">Loop</span>
          <span id="sem-loop" class="w-2.5 h-2.5 rounded-full bg-slate-600"></span>
        </div>
        <div class="flex items-center gap-1" title="WebSocket">
          <span class="text-xs text-slate-400">WS</span>
          <span id="sem-ws" class="w-2.5 h-2.5 rounded-full bg-slate-600"></span>
        </div>
        <div class="flex items-center gap-1" title="Gamma">
          <span class="text-xs text-slate-400">Gamma</span>
          <span id="sem-gamma" class="w-2.5 h-2.5 rounded-full bg-slate-600"></span>
        </div>
      </div>
      <span id="uptime" class="text-xs text-slate-500"></span>
      <span id="refresh-indicator" class="w-2 h-2 rounded-full bg-blue-500 pulse-dot" title="Auto-refreshing"></span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- Alert Banner -->
    <div id="alert-banner" class="hidden rounded-lg border px-4 py-3 text-sm font-medium"></div>
    
    <!-- KPI: All-Time -->
    <div>
      <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 font-semibold">üìä All-Time</div>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">PnL</div>
          <div id="kpi-pnl-all" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Win Rate</div>
          <div id="kpi-wr-all" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Trades</div>
          <div id="kpi-trades-all" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Since</div>
          <div id="kpi-since" class="text-lg font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Balance</div>
          <div id="kpi-balance" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- KPI: Today -->
    <div>
      <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 font-semibold">üìÖ Today</div>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">PnL</div>
          <div id="kpi-pnl" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Win Rate</div>
          <div id="kpi-wr" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Trades</div>
          <div id="kpi-trades" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Open Positions</div>
          <div id="kpi-open" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
        <div class="bg-card rounded-lg p-4 border border-slate-700">
          <div class="text-xs text-slate-400 uppercase tracking-wide">Watchlist</div>
          <div id="kpi-watchlist" class="text-2xl font-bold mono mt-1">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Open Positions -->
    <section class="bg-card rounded-lg border border-slate-700">
      <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between">
        <h2 class="font-semibold text-white">üìä Open Positions</h2>
        <span id="positions-count" class="text-xs text-slate-400"></span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-xs text-slate-400 uppercase bg-slate-800/50">
            <tr>
              <th class="px-4 py-2 text-left">Market</th>
              <th class="px-4 py-2 text-left">League</th>
              <th class="px-4 py-2 text-right">Entry</th>
              <th class="px-4 py-2 text-right">Current</th>
              <th class="px-4 py-2 text-right">PnL</th>
              <th class="px-4 py-2 text-right">Age</th>
            </tr>
          </thead>
          <tbody id="positions-body" class="divide-y divide-slate-700/50"></tbody>
        </table>
        <div id="positions-empty" class="hidden px-4 py-6 text-center text-slate-500 text-sm">No open positions</div>
      </div>
    </section>

    <!-- Trades Today -->
    <section class="bg-card rounded-lg border border-slate-700">
      <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between">
        <h2 class="font-semibold text-white">üí∞ Trades Today</h2>
        <span id="trades-summary" class="text-xs text-slate-400"></span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-xs text-slate-400 uppercase bg-slate-800/50">
            <tr>
              <th class="px-4 py-2 text-left">Result</th>
              <th class="px-4 py-2 text-left">Market</th>
              <th class="px-4 py-2 text-left">League</th>
              <th class="px-4 py-2 text-right">Entry</th>
              <th class="px-4 py-2 text-right">Exit</th>
              <th class="px-4 py-2 text-right">PnL</th>
              <th class="px-4 py-2 text-right">ROI</th>
              <th class="px-4 py-2 text-right">Duration</th>
            </tr>
          </thead>
          <tbody id="trades-body" class="divide-y divide-slate-700/50"></tbody>
        </table>
        <div id="trades-empty" class="hidden px-4 py-6 text-center text-slate-500 text-sm">No trades today</div>
      </div>
    </section>

    <!-- Two columns: Watchlist + Stats -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Watchlist (2/3 width) -->
      <section class="lg:col-span-2 bg-card rounded-lg border border-slate-700">
        <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between">
          <h2 class="font-semibold text-white">üëÅÔ∏è Watchlist Live <span id="wl-count" class="text-slate-400 font-normal">(0)</span></h2>
          <div class="flex gap-2" id="watchlist-filters">
            <button onclick="setWlFilter('all')" class="wl-filter text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300 hover:bg-slate-600" data-f="all">All</button>
            <button onclick="setWlFilter('signaled')" class="wl-filter text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300 hover:bg-slate-600" data-f="signaled">Signaled</button>
            <button onclick="setWlFilter('watching')" class="wl-filter text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300 hover:bg-slate-600" data-f="watching">Watching</button>
          </div>
        </div>
        <div class="overflow-x-auto max-h-96 overflow-y-auto">
          <table class="w-full text-sm">
            <thead class="text-xs text-slate-400 uppercase bg-slate-800/50 sticky top-0">
              <tr>
                <th class="px-3 py-2 text-left">Status</th>
                <th class="px-3 py-2 text-left">Market</th>
                <th class="px-3 py-2 text-left">League</th>
                <th class="px-3 py-2 text-right">Bid</th>
                <th class="px-3 py-2 text-right">Ask</th>
                <th class="px-3 py-2 text-right">Spread</th>
                <th class="px-3 py-2 text-left">Reject</th>
              </tr>
            </thead>
            <tbody id="watchlist-body" class="divide-y divide-slate-700/50"></tbody>
          </table>
        </div>
      </section>

      <!-- Right sidebar: Stats -->
      <section class="space-y-4">
        
        <!-- Loop Performance -->
        <div class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-3">‚ö° Loop Performance</h3>
          <div class="space-y-2 text-sm" id="loop-stats">
            <div class="flex justify-between"><span class="text-slate-400">Last cycle</span><span id="loop-avg" class="mono">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Slow loops</span><span id="loop-slow" class="mono">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">WS ratio</span><span id="loop-ws" class="mono">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Runs (boot)</span><span id="loop-runs" class="mono">‚Äî</span></div>
          </div>
          <div id="loop-breakdown" class="mt-3"></div>
          <div id="loop-histogram" class="mt-3 space-y-1"></div>
        </div>

        <!-- Opportunity Tracker: Near Misses (Active) -->
        <div class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-2">üîç Near Misses <span class="text-slate-500 font-normal" id="nm-count"></span></h3>
          <div class="overflow-x-auto">
            <table class="w-full text-xs" id="near-miss-table">
              <thead class="text-slate-500 text-[10px] uppercase">
                <tr>
                  <th class="text-left pb-1 pr-2">Market</th>
                  <th class="text-left pb-1 pr-2">Block Reason</th>
                  <th class="text-right pb-1 pr-2">Ask</th>
                  <th class="text-right pb-1 pr-2">Bid</th>
                  <th class="text-right pb-1 pr-2">Spread</th>
                  <th class="text-right pb-1 pr-2">Depth</th>
                  <th class="text-right pb-1">Time</th>
                </tr>
              </thead>
              <tbody id="near-misses"></tbody>
            </table>
          </div>
          <div id="near-miss-empty" class="text-slate-500 text-xs py-1">No active near misses</div>
        </div>

        <!-- Opportunity Tracker: Stage Fails -->
        <div class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-2">‚ö° Stage Fails <span id="stage-fail-age" class="text-slate-500 text-xs font-normal"></span></h3>
          <div class="space-y-1" id="stage-fails"></div>
          <div id="stage-fail-empty" class="text-slate-500 text-xs">No recent stage fails</div>
        </div>

        <!-- Opportunity Tracker: Closed Today -->
        <div class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-2">üìã Closed Today <span class="text-slate-500 font-normal" id="ct-count"></span></h3>
          <div class="overflow-x-auto">
            <table class="w-full text-xs" id="closed-opp-table">
              <thead class="text-slate-500 text-[10px] uppercase">
                <tr>
                  <th class="text-left pb-1 pr-2">Market</th>
                  <th class="text-left pb-1 pr-2">Why Blocked</th>
                  <th class="text-right pb-1 pr-2">Entry Ask</th>
                  <th class="text-right pb-1 pr-2">Peak Bid</th>
                  <th class="text-right pb-1 pr-2">Trough Bid</th>
                  <th class="text-right pb-1 pr-2">Ticks</th>
                  <th class="text-right pb-1">Tracked</th>
                </tr>
              </thead>
              <tbody id="closed-opps"></tbody>
            </table>
          </div>
          <div id="closed-opp-empty" class="text-slate-500 text-xs py-1">No closed opportunities today</div>
        </div>

        <!-- Timeout Analysis ‚Äî split by category -->
        <div class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-3">‚è±Ô∏è Timeout Analysis</h3>
          <!-- Price Window -->
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">6s Price Window</div>
          <div class="space-y-1 text-sm mb-3" id="to-pw">
            <div class="flex justify-between"><span class="text-slate-400">Total</span><span id="to-pw-total" class="mono">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Cost us</span><span id="to-pw-cost" class="mono text-red-400">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Saved us</span><span id="to-pw-saved" class="mono text-emerald-400">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Lost PnL</span><span id="to-pw-pnl" class="mono text-red-400">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Saved PnL</span><span id="to-pw-saved-pnl" class="mono text-emerald-400">‚Äî</span></div>
          </div>
          <!-- Confirmation Filters -->
          <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Confirmation Filters</div>
          <div class="space-y-1 text-sm mb-2" id="to-cf">
            <div class="flex justify-between"><span class="text-slate-400">Total</span><span id="to-cf-total" class="mono">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Cost us</span><span id="to-cf-cost" class="mono text-red-400">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Saved us</span><span id="to-cf-saved" class="mono text-emerald-400">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Lost PnL</span><span id="to-cf-pnl" class="mono text-red-400">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Saved PnL</span><span id="to-cf-saved-pnl" class="mono text-emerald-400">‚Äî</span></div>
          </div>
          <div id="to-cf-reasons" class="text-xs text-slate-500"></div>
        </div>

        <!-- Daily Utilization -->
        <div class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-3">üìà Daily Utilization</h3>
          <div class="space-y-2" id="daily-util"></div>
          <div id="daily-empty" class="text-slate-500 text-xs">No data yet</div>
        </div>

        <!-- Execution Status -->
        <div id="exec-panel" class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-3">üí∏ Execution Status</h3>
          <div id="exec-content" class="space-y-2 text-xs"></div>
        </div>

        <!-- Config -->
        <div class="bg-card rounded-lg border border-slate-700 p-4">
          <h3 class="font-semibold text-white text-sm mb-3">‚öôÔ∏è Config</h3>
          <div class="space-y-1 text-xs mono" id="config-display"></div>
        </div>

      </section>
    </div>

  </main>

  <!-- Footer -->
  <footer class="text-center text-xs text-slate-600 py-4">
    <span id="last-update">‚Äî</span> ¬∑ <span id="data-age">‚Äî</span>
  </footer>

  <script>
    // State
    let wlFilter = 'all';
    let allData = {};

    function setWlFilter(f) {
      wlFilter = f;
      document.querySelectorAll('.wl-filter').forEach(b => {
        b.classList.toggle('bg-blue-600', b.dataset.f === f);
        b.classList.toggle('text-white', b.dataset.f === f);
        b.classList.toggle('bg-slate-700', b.dataset.f !== f);
      });
      if (allData.watchlist) renderWatchlist(allData.watchlist);
    }

    // Helpers
    function $(id) { return document.getElementById(id); }
    function ago(ms) {
      if (!ms || ms <= 0) return '‚Äî';
      const s = Math.round(ms / 1000);
      if (s < 60) return s + 's';
      const m = Math.round(s / 60);
      if (m < 60) return m + 'm';
      const h = Math.round(m / 60);
      return h + 'h';
    }
    function dur(ms) {
      if (!ms) return '‚Äî';
      const s = Math.round(ms / 1000);
      if (s < 60) return s + 's';
      const m = Math.floor(s / 60);
      return m + 'm ' + (s % 60) + 's';
    }
    function pnlColor(v) { return v > 0 ? 'text-emerald-400' : v < 0 ? 'text-red-400' : 'text-slate-300'; }
    function pnlStr(v) { return v == null ? '‚Äî' : (v >= 0 ? '+$' + v.toFixed(2) : '-$' + Math.abs(v).toFixed(2)); }
    function semColor(level) {
      if (level === 'green') return 'bg-emerald-500';
      if (level === 'yellow') return 'bg-yellow-500';
      if (level === 'red') return 'bg-red-500';
      return 'bg-slate-600';
    }
    function statusBadge(s) {
      const colors = {
        signaled: 'bg-blue-500/20 text-blue-400',
        pending_signal: 'bg-yellow-500/20 text-yellow-400',
        watching: 'bg-slate-500/20 text-slate-400',
        expired: 'bg-red-500/20 text-red-400',
      };
      return `<span class="text-xs px-1.5 py-0.5 rounded ${colors[s] || 'bg-slate-500/20 text-slate-400'}">${s}</span>`;
    }
    function leagueBadge(l) {
      const colors = { nba: 'text-orange-400', cbb: 'text-blue-400', esports: 'text-purple-400', soccer: 'text-green-400' };
      return `<span class="text-xs ${colors[l] || 'text-slate-400'}">${(l||'?').toUpperCase()}</span>`;
    }
    function truncSlug(s, max=40) { return s && s.length > max ? s.slice(0, max) + '‚Ä¶' : s || '‚Äî'; }
    function formatMarketTitle(m) {
      const base = m.title || truncSlug(m.slug, 35);
      const slug = m.slug || '';
      const gameMatch = slug.match(/[-_](game|map)(\d+)$/i);
      if (gameMatch) return base + ` <span class="text-blue-400 font-medium">‚Äî ${gameMatch[1].charAt(0).toUpperCase() + gameMatch[1].slice(1)} ${gameMatch[2]}</span>`;
      // Check if it's a series main market (has sub-markets) ‚Äî no suffix needed, but mark it
      if (m.market_kind === 'match_series') return base + ' <span class="text-slate-500">(Series)</span>';
      return base;
    }

    // Render functions
    function renderAlerts(h) {
      if (!h) return;
      const alerts = [];
      const loopAge = h.loop?.last_cycle_age_seconds;
      if (loopAge != null && loopAge > 30) alerts.push(`üî¥ Loop stale: last cycle ${loopAge}s ago`);
      else if (loopAge != null && loopAge > 10) alerts.push(`üü° Loop slow: last cycle ${loopAge}s ago`);

      const wsRatio = h.websocket?.usage?.ws_ratio_percent ?? null;
      if (wsRatio != null && wsRatio < 50) alerts.push(`üî¥ WS degraded: ${wsRatio.toFixed(0)}% ratio`);
      if (h.websocket?.is_connected === false) alerts.push(`üî¥ WebSocket disconnected`);

      const gammaAge = h.staleness?.gamma_stale_seconds;
      if (gammaAge != null && gammaAge > 300) alerts.push(`üü° Gamma stale: ${Math.round(gammaAge/60)}min since last poll`);

      const slowLoops = h.loop?.slow_loops;
      if (slowLoops != null && slowLoops > 20) alerts.push(`üü° ${slowLoops} slow loops since boot`);

      const banner = $('alert-banner');
      if (alerts.length === 0) {
        banner.classList.add('hidden');
      } else {
        banner.classList.remove('hidden');
        const isRed = alerts.some(a => a.startsWith('üî¥'));
        banner.className = `rounded-lg border px-4 py-3 text-sm font-medium ${isRed ? 'bg-red-500/10 border-red-500/30 text-red-400' : 'bg-yellow-500/10 border-yellow-500/30 text-yellow-400'}`;
        banner.innerHTML = alerts.join(' &nbsp;¬∑&nbsp; ');
      }
    }

    function renderHealth(h) {
      if (!h) return;
      renderAlerts(h);
      const rId = h.runner_id || 'prod';
      $('runner-badge').textContent = rId;
      if (h.is_shadow) {
        $('runner-badge').className = 'text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400 mono';
      }
      // Trading mode badge
      const tb = h.trade_bridge || {};
      const tMode = tb.mode || 'paper';
      const tmEl = $('trading-mode');
      tmEl.textContent = tb.paused ? `${tMode} (PAUSED)` : tMode;
      const tmColors = {
        paper: 'bg-slate-500/20 text-slate-400',
        shadow_live: 'bg-yellow-500/20 text-yellow-400',
        live: 'bg-emerald-500/20 text-emerald-400',
      };
      tmEl.className = 'text-xs px-2 py-0.5 rounded-full mono ' + (tb.paused ? 'bg-red-500/20 text-red-400' : (tmColors[tMode] || tmColors.paper));

      // Balance
      const lastBal = tb.last_balance;
      if (lastBal != null) {
        $('kpi-balance').textContent = '$' + Number(lastBal).toFixed(2);
        $('kpi-balance').className = 'text-2xl font-bold mono mt-1 text-white';
      }

      $('build').textContent = h.build_commit || '';
      $('uptime').textContent = 'up ' + ago((h.uptime_seconds || 0) * 1000);

      // Semaphores
      const loopAge = h.loop?.last_cycle_age_seconds;
      $('sem-loop').className = 'w-2.5 h-2.5 rounded-full ' + semColor(loopAge == null ? 'red' : loopAge < 5 ? 'green' : loopAge < 15 ? 'yellow' : 'red');

      const wsRatio2 = h.websocket?.usage?.ws_ratio_percent ?? null;
      $('sem-ws').className = 'w-2.5 h-2.5 rounded-full ' + semColor(wsRatio2 == null ? 'yellow' : wsRatio2 > 90 ? 'green' : wsRatio2 > 50 ? 'yellow' : 'red');

      const gammaAge = h.staleness?.gamma_stale_seconds;
      $('sem-gamma').className = 'w-2.5 h-2.5 rounded-full ' + semColor(gammaAge == null ? 'yellow' : gammaAge < 120 ? 'green' : gammaAge < 300 ? 'yellow' : 'red');

      // Loop stats
      const perf = h.loop?.performance || {};
      $('loop-avg').textContent = perf.last_loop_ms != null ? perf.last_loop_ms + 'ms' : (h.loop?.cycle_duration_ms_avg != null ? Math.round(h.loop.cycle_duration_ms_avg) + 'ms' : '‚Äî');
      $('loop-slow').textContent = perf.slow_loops != null ? perf.slow_loops : '‚Äî';
      $('loop-ws').textContent = wsRatio2 != null ? wsRatio2.toFixed(1) + '%' : '‚Äî';
      $('loop-runs').textContent = h.loop?.runs || '‚Äî';

      // Loop breakdown
      const bd = perf.last_breakdown;
      if (bd) {
        const parts = [['gamma', bd.gamma_ms], ['eval', bd.eval_ms], ['journal', bd.journal_ms], ['resolution', bd.resolution_ms], ['persist', bd.persist_ms]].filter(p => p[1] > 0);
        const total = parts.reduce((s, p) => s + p[1], 0) || 1;
        const colors = { gamma: 'bg-purple-500', eval: 'bg-blue-500', journal: 'bg-yellow-500', resolution: 'bg-emerald-500', persist: 'bg-red-500' };
        const breakdownEl = $('loop-breakdown');
        if (breakdownEl) {
          breakdownEl.innerHTML = `<div class="flex h-2 rounded-full overflow-hidden bg-slate-700">${parts.map(([n, ms]) => 
            `<div class="${colors[n] || 'bg-slate-500'}" style="width:${Math.max((ms/total)*100, 2)}%" title="${n}: ${ms}ms"></div>`
          ).join('')}</div><div class="flex justify-between text-[10px] text-slate-500 mt-0.5">${parts.map(([n, ms]) => `<span>${n} ${ms}ms</span>`).join('')}</div>`;
        }
      }

      // Histogram
      const hist = perf.histogram;
      if (hist) {
        const histEl = $('loop-histogram');
        if (histEl) {
          const maxH = Math.max(...Object.values(hist), 1);
          histEl.innerHTML = Object.entries(hist).map(([bucket, count]) => 
            `<div class="flex items-center gap-1.5"><span class="text-[10px] text-slate-500 w-14 text-right">${bucket}</span><div class="flex-1 bg-slate-700 rounded-full h-1.5 overflow-hidden"><div class="h-full bg-blue-500/60 rounded-full" style="width:${Math.max((count/maxH)*100, count > 0 ? 3 : 0)}%"></div></div><span class="text-[10px] mono text-slate-400 w-6 text-right">${count}</span></div>`
          ).join('');
        }
      }

      // Opportunity Tracker
      const opp = h.opportunity_tracker || {};
      const fmtDur = s => s >= 3600 ? Math.floor(s/3600)+'h'+Math.floor((s%3600)/60)+'m' : s >= 60 ? Math.floor(s/60)+'m'+('0'+(s%60)).slice(-2)+'s' : s+'s';
      const fmtP = v => v != null ? v.toFixed(2) : '‚Äî';
      const fmtP3 = v => v != null ? v.toFixed(3) : '‚Äî';
      const stripGate = r => (r || '‚Äî').replace(/^(soccer|cbb|nba|esports)_gate:/, '');

      // Near Misses
      const nm = opp.near_misses || [];
      $('nm-count').textContent = nm.length ? `(${nm.length})` : '';
      $('near-miss-table').style.display = nm.length ? '' : 'none';
      $('near-miss-empty').style.display = nm.length ? 'none' : '';
      $('near-misses').innerHTML = nm.map(m => {
        const ctx = m.best_ask_with_context || {};
        const ask = ctx.ask ?? m.ask;
        const bid = ctx.bid ?? m.bid;
        const spread = ctx.spread ?? (ask != null && bid != null ? ask - bid : null);
        const depth = ctx.entry_depth_usd_ask;
        const secs = Math.round((m.time_tracked_ms || 0) / 1000);
        return `<tr class="border-t border-slate-800 hover:bg-slate-800/50">
          <td class="py-1 pr-2 text-slate-300 max-w-[180px] truncate" title="${m.slug}">${m.slug}</td>
          <td class="py-1 pr-2 text-amber-400 whitespace-nowrap">${stripGate(m.reject_reason)}</td>
          <td class="py-1 pr-2 text-right mono text-slate-300">${fmtP3(ask)}</td>
          <td class="py-1 pr-2 text-right mono text-slate-400">${fmtP3(bid)}</td>
          <td class="py-1 pr-2 text-right mono ${spread != null && spread <= 0.02 ? 'text-emerald-400' : 'text-slate-400'}">${spread != null ? spread.toFixed(3) : '‚Äî'}</td>
          <td class="py-1 pr-2 text-right mono ${depth != null && depth >= 500 ? 'text-emerald-400' : 'text-slate-500'}">${depth != null ? '$'+Math.round(depth) : '‚Äî'}</td>
          <td class="py-1 text-right mono text-slate-500">${fmtDur(secs)}</td>
        </tr>`;
      }).join('');

      // Stage Fails
      const sf = opp.stage_fails || [];
      const sfAge = opp.stage_fail_age_seconds;
      $('stage-fail-age').textContent = sfAge != null ? '(' + (sfAge >= 60 ? Math.floor(sfAge/60) + 'm ago' : sfAge + 's ago') + ')' : '';
      if (sf.length) {
        $('stage-fail-empty').classList.add('hidden');
        const maxSf = sf[0]?.count || 1;
        $('stage-fails').innerHTML = sf.slice(0, 8).map(s => {
          const pct = Math.round((s.count / maxSf) * 100);
          const label = s.reason.replace(/^(soccer|cbb|nba|esports):/, '');
          return `<div class="flex items-center gap-2">
            <div class="flex-1 bg-slate-700 rounded-full h-1.5 overflow-hidden">
              <div class="h-full bg-orange-500/60 rounded-full" style="width:${pct}%"></div>
            </div>
            <span class="text-xs text-slate-400 whitespace-nowrap">${label}</span>
            <span class="text-xs mono text-slate-300 w-8 text-right">${s.count}</span>
          </div>`;
        }).join('');
      } else {
        $('stage-fail-empty').classList.remove('hidden');
        $('stage-fails').innerHTML = '';
      }

      // Closed Opportunities Today
      const ct = opp.closed_today || [];
      $('ct-count').textContent = ct.length ? `(${ct.length})` : '';
      $('closed-opp-table').style.display = ct.length ? '' : 'none';
      $('closed-opp-empty').style.display = ct.length ? 'none' : '';
      $('closed-opps').innerHTML = ct.map(c => {
        const block = stripGate(c.entry_block_reason || c.close_reason);
        const isTraded = c.close_reason === 'traded';
        const bestAsk = c.best_ask_with_context?.ask ?? c.best_ask_seen;
        const peakBid = c.best_bid_seen;
        const troughBid = c.worst_bid_seen;
        const ticks = c.total_ticks || 0;
        const secs = Math.round((c.tracking_duration_ms || 0) / 1000);
        // Color peak bid: green if resolved (>0.99), red if SL zone (<0.70)
        const peakCls = peakBid != null && peakBid > 0.99 ? 'text-emerald-400' : 'text-slate-400';
        const troughCls = troughBid != null && troughBid < 0.70 ? 'text-red-400' : 'text-slate-400';
        return `<tr class="border-t border-slate-800 hover:bg-slate-800/50">
          <td class="py-1 pr-2 max-w-[160px] truncate ${isTraded ? 'text-emerald-400' : 'text-slate-300'}" title="${c.slug}">${c.slug}</td>
          <td class="py-1 pr-2 ${isTraded ? 'text-emerald-400' : 'text-amber-400'} whitespace-nowrap">${isTraded ? '‚úÖ traded' : block}</td>
          <td class="py-1 pr-2 text-right mono text-slate-300">${fmtP3(bestAsk)}</td>
          <td class="py-1 pr-2 text-right mono ${peakCls}">${fmtP3(peakBid)}</td>
          <td class="py-1 pr-2 text-right mono ${troughCls}">${fmtP3(troughBid)}</td>
          <td class="py-1 pr-2 text-right mono text-slate-500">${ticks}</td>
          <td class="py-1 text-right mono text-slate-500">${fmtDur(secs)}</td>
        </tr>`;
      }).join('');

      // Daily utilization ‚Äî universe funnel per league
      const uf = h.universe_funnel;
      const du = h.daily_utilization;
      if (uf && uf.by_league && Object.keys(uf.by_league).length) {
        $('daily-empty').classList.add('hidden');
        $('daily-util').innerHTML = Object.entries(uf.by_league)
          .sort((a,b) => (b[1].available || 0) - (a[1].available || 0))
          .map(([league, f]) => {
          const avail = f.available || 0;
          const wl = f.watchlisted || 0;
          const sig = f.signaled || 0;
          const cap = f.capture_pct || 0;
          // PnL from daily_utilization
          const d = du?.[league] || {};
          const wins = d.wins || 0;
          const losses = d.losses || 0;
          const pnl = d.pnl || 0;
          const to = d.timeouts || 0;
          const toCost = d.timeout_cost || 0;
          const pnlStr = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
          const pnlCls = pnl >= 0 ? 'text-emerald-400' : 'text-red-400';
          const closedStr = (wins + losses) > 0 ? `${wins}W/${losses}L` : '';
          const toStr = to > 0 ? `${to}TO${toCost?'('+toCost+'üí∏)':''}` : '';
          const detail = [closedStr, toStr].filter(Boolean).join(' ¬∑ ');
          // Funnel bar: two segments (watchlisted in dark blue, signaled in bright blue)
          const wlPct = avail > 0 ? Math.round((wl / avail) * 100) : 0;
          const sigPct = avail > 0 ? Math.round((sig / avail) * 100) : 0;
          return `<div class="mb-2.5">
            <div class="flex justify-between text-xs mb-0.5">
              <div class="flex items-center gap-2">
                ${leagueBadge(league)}
                <span class="text-slate-400 mono">${sig}/${avail}</span>
                <span class="text-slate-500">(${cap}%)</span>
              </div>
              <div class="flex items-center gap-2">
                ${detail ? `<span class="text-slate-400">${detail}</span>` : ''}
                ${(wins+losses)>0 ? `<span class="${pnlCls} mono">${pnlStr}</span>` : ''}
              </div>
            </div>
            <div class="bg-slate-700 rounded-full h-2 overflow-hidden flex">
              <div class="h-full bg-blue-500" style="width:${Math.max(sigPct, avail>0?1:0)}%"></div>
              <div class="h-full bg-blue-900" style="width:${Math.max(wlPct - sigPct, 0)}%"></div>
            </div>
            <div class="text-[10px] text-slate-500 mt-0.5">${avail} avail ‚Üí ${wl} watchlisted ‚Üí ${sig} signaled</div>
          </div>`;
        }).join('');
      }
    }

    function renderPositions(data) {
      if (!data) return;
      const items = data.items || [];
      $('positions-count').textContent = items.length + ' position' + (items.length !== 1 ? 's' : '');
      if (!items.length) {
        $('positions-body').innerHTML = '';
        $('positions-empty').classList.remove('hidden');
        return;
      }
      $('positions-empty').classList.add('hidden');
      const now = Date.now();
      $('positions-body').innerHTML = items.map(p => {
        const curPrice = p.price_tracking?.price_last ?? null;
        const pnl = curPrice != null ? ((curPrice - p.entry_price) / p.entry_price * p.paper_notional_usd) : null;
        const ageMs = now - (p.ts_open || now);
        return `<tr class="hover:bg-slate-800/50">
          <td class="px-4 py-2 text-left"><span class="text-xs" title="${p.slug}">${formatMarketTitle(p)}</span></td>
          <td class="px-4 py-2 text-left">${leagueBadge(p.league)}</td>
          <td class="px-4 py-2 text-right mono text-xs">${(p.entry_price||0).toFixed(3)}</td>
          <td class="px-4 py-2 text-right mono text-xs">${curPrice != null ? curPrice.toFixed(3) : '<span class="text-slate-500">‚Äî</span>'}</td>
          <td class="px-4 py-2 text-right mono text-xs ${pnlColor(pnl)}">${pnlStr(pnl)}</td>
          <td class="px-4 py-2 text-right text-xs text-slate-400">${ago(ageMs)}</td>
        </tr>`;
      }).join('');
    }

    function renderTrades(data) {
      if (!data) return;
      const s = data.summary || {};
      const items = data.items || [];

      // KPIs: Today
      $('kpi-pnl').textContent = pnlStr(s.pnl_today);
      $('kpi-pnl').className = 'text-2xl font-bold mono mt-1 ' + pnlColor(s.pnl_today);
      $('kpi-wr').textContent = s.wr_today || '‚Äî';
      $('kpi-trades').textContent = s.trades_today ?? '‚Äî';

      // KPIs: All-Time
      $('kpi-pnl-all').textContent = pnlStr(s.pnl_total);
      $('kpi-pnl-all').className = 'text-2xl font-bold mono mt-1 ' + pnlColor(s.pnl_total);
      $('kpi-wr-all').textContent = s.wr_total || '‚Äî';
      $('kpi-trades-all').textContent = s.trades_total ?? '‚Äî';
      if (s.first_trade_ts) {
        const d = new Date(s.first_trade_ts);
        $('kpi-since').textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      $('trades-summary').textContent = `${s.wins_today||0}W / ${s.losses_today||0}L ¬∑ $${(s.pnl_total||0).toFixed(2)} all-time`;

      // Timeout stats ‚Äî split by category
      const pw = s.timeouts_price_window || {};
      $('to-pw-total').textContent = pw.total ?? 0;
      $('to-pw-cost').textContent = pw.cost ?? 0;
      $('to-pw-saved').textContent = pw.saved ?? 0;
      $('to-pw-pnl').textContent = pw.lost_pnl ? `-$${pw.lost_pnl.toFixed(2)}` : '$0';
      $('to-pw-saved-pnl').textContent = pw.saved_pnl ? `+$${pw.saved_pnl.toFixed(2)}` : '$0';
      const cf = s.timeouts_confirmation || {};
      $('to-cf-total').textContent = cf.total ?? 0;
      $('to-cf-cost').textContent = cf.cost ?? 0;
      $('to-cf-saved').textContent = cf.saved ?? 0;
      $('to-cf-pnl').textContent = cf.lost_pnl ? `-$${cf.lost_pnl.toFixed(2)}` : '$0';
      $('to-cf-saved-pnl').textContent = cf.saved_pnl ? `+$${cf.saved_pnl.toFixed(2)}` : '$0';
      // Sub-reason breakdown
      const reasons = cf.by_reason || {};
      const reasonStr = Object.entries(reasons).sort((a,b) => b[1]-a[1]).map(([r,c]) => `${r.replace('fail_','')}: ${c}`).join(' ¬∑ ');
      $('to-cf-reasons').textContent = reasonStr || '';

      if (!items.length) {
        $('trades-body').innerHTML = '';
        $('trades-empty').classList.remove('hidden');
        return;
      }
      $('trades-empty').classList.add('hidden');
      $('trades-body').innerHTML = items.reverse().map(t => {
        const badge = t.win === true ? '<span class="text-xs px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400">WIN</span>'
          : t.win === false ? '<span class="text-xs px-1.5 py-0.5 rounded bg-red-500/20 text-red-400">LOSS</span>'
          : '<span class="text-xs px-1.5 py-0.5 rounded bg-slate-500/20 text-slate-400">?</span>';
        const durMs = (t.ts_close || 0) - (t.ts_open || 0);
        return `<tr class="hover:bg-slate-800/50">
          <td class="px-4 py-2">${badge}</td>
          <td class="px-4 py-2 text-left"><span class="text-xs" title="${t.slug}">${t.title || truncSlug(t.slug)}</span></td>
          <td class="px-4 py-2">${leagueBadge(t.league)}</td>
          <td class="px-4 py-2 text-right mono text-xs">${(t.entry_price||0).toFixed(3)}</td>
          <td class="px-4 py-2 text-right mono text-xs">${t.exit_price != null ? t.exit_price.toFixed(3) : '‚Äî'}</td>
          <td class="px-4 py-2 text-right mono text-xs ${pnlColor(t.pnl_usd)}">${pnlStr(t.pnl_usd)}</td>
          <td class="px-4 py-2 text-right mono text-xs">${t.roi != null ? (t.roi * 100).toFixed(1) + '%' : '‚Äî'}</td>
          <td class="px-4 py-2 text-right text-xs text-slate-400">${dur(durMs)}</td>
        </tr>`;
      }).join('');
    }

    function renderWatchlist(data) {
      if (!data) return;
      let items = data.items || [];
      $('kpi-watchlist').textContent = items.length;
      $('wl-count').textContent = `(${items.length})`;
      $('kpi-open').textContent = allData.positions?.items?.length ?? '‚Äî';

      if (wlFilter !== 'all') items = items.filter(i => i.status === wlFilter);

      // Sort: signaled first, then pending, then watching ‚Äî within same status, highest ask first
      const order = { signaled: 0, pending_signal: 1, watching: 2, expired: 3 };
      items.sort((a, b) => {
        const sa = order[a.status] ?? 9;
        const sb = order[b.status] ?? 9;
        if (sa !== sb) return sa - sb;
        const askA = Number(a.last_price?.yes_best_ask ?? 0);
        const askB = Number(b.last_price?.yes_best_ask ?? 0);
        return askB - askA;
      });

      const maxSpread = Number(data?.filters?.max_spread ?? 0.02);
      $('watchlist-body').innerHTML = items.map(m => {
        const lp = m.last_price || {};
        const bid = lp.yes_best_bid;
        const ask = lp.yes_best_ask;
        const spread = lp.spread;
        const reject = m.last_reject?.reason || '';
        return `<tr class="hover:bg-slate-800/50">
          <td class="px-3 py-1.5">${statusBadge(m.status)}</td>
          <td class="px-3 py-1.5 text-xs" title="${m.slug}">${formatMarketTitle(m)}</td>
          <td class="px-3 py-1.5">${leagueBadge(m.league)}</td>
          <td class="px-3 py-1.5 text-right mono text-xs">${bid != null ? bid.toFixed(3) : '‚Äî'}</td>
          <td class="px-3 py-1.5 text-right mono text-xs">${ask != null ? ask.toFixed(3) : '‚Äî'}</td>
          <td class="px-3 py-1.5 text-right mono text-xs ${spread != null && spread > maxSpread ? 'text-yellow-400' : ''}">${spread != null ? spread.toFixed(3) : '‚Äî'}</td>
          <td class="px-3 py-1.5 text-xs text-slate-500 whitespace-nowrap">${reject}</td>
        </tr>`;
      }).join('');
    }

    function renderConfig(data) {
      if (!data || !data.config) return;
      const c = data.config;
      const lines = [];
      function flat(obj, prefix) {
        for (const [k, v] of Object.entries(obj || {})) {
          const key = prefix ? prefix + '.' + k : k;
          if (v && typeof v === 'object' && !Array.isArray(v)) flat(v, key);
          else lines.push([key, JSON.stringify(v)]);
        }
      }
      flat(c, '');
      $('config-display').innerHTML = lines.slice(0, 20).map(([k, v]) =>
        `<div class="flex justify-between gap-2"><span class="text-slate-500 truncate">${k}</span><span class="text-slate-300">${v}</span></div>`
      ).join('');
    }

    function renderExecutions(data) {
      const el = $('exec-content');
      if (!data) { el.innerHTML = '<span class="text-slate-500">No data</span>'; return; }

      const mode = data.mode || 'paper';
      const paused = data.paused;
      const bal = data.balance_usd;
      const s = data.summary || {};
      const div = data.divergence || {};

      const modeColors = { paper: 'bg-slate-600', shadow_live: 'bg-yellow-600', live: 'bg-emerald-600' };
      const modeBadge = `<span class="px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${modeColors[mode] || 'bg-slate-600'}">${mode}</span>`;
      const pauseBadge = paused ? ' <span class="px-1.5 py-0.5 rounded text-[10px] font-bold uppercase bg-red-600">PAUSED</span>' : '';

      // Divergence alert
      const divOk = div.ok !== false;
      const divAlert = divOk ? '' :
        `<div class="bg-red-900/40 border border-red-700 rounded p-2 text-red-300">
          ‚ö†Ô∏è Divergence: ${div.signals_without_buy || 0} signals without buy, ${div.signals_without_sell || 0} signals without sell
        </div>`;

      const balStr = bal != null ? `$${Number(bal).toFixed(2)}` : '‚Äî';

      let rows = '';
      if (mode === 'paper') {
        rows = '<div class="text-slate-500 italic">Paper mode ‚Äî no real trades</div>';
      } else if (s.total_today === 0 && !paused) {
        rows = '<div class="text-slate-500 italic">No executions today</div>';
      } else {
        rows = `<div class="grid grid-cols-2 gap-x-4 gap-y-1">
          <span class="text-slate-400">Buys</span><span class="text-emerald-400 mono">${s.buys_today || 0}</span>
          <span class="text-slate-400">Sells</span><span class="text-blue-400 mono">${s.sells_today || 0}</span>
          <span class="text-slate-400">Failed</span><span class="${(s.failed_today || 0) > 0 ? 'text-red-400' : 'text-slate-300'} mono">${s.failed_today || 0}</span>
        </div>`;
      }

      el.innerHTML = `
        <div class="flex items-center gap-2 mb-2">${modeBadge}${pauseBadge}
        </div>
        ${divAlert}
        ${rows}
      `;
    }

    // Fetch all endpoints
    async function fetchAll() {
      try {
        const [health, trades, positions, watchlist, config, executions] = await Promise.all([
          fetch('/api/health').then(r => r.json()).catch(() => null),
          fetch('/api/trades').then(r => r.json()).catch(() => null),
          fetch('/api/positions').then(r => r.json()).catch(() => null),
          fetch('/api/watchlist').then(r => r.json()).catch(() => null),
          fetch('/api/config').then(r => r.json()).catch(() => null),
          fetch('/api/executions').then(r => r.json()).catch(() => null),
        ]);
        allData = { health, trades, positions, watchlist, config, executions };
        renderHealth(health);
        renderTrades(trades);
        renderPositions(positions);
        renderWatchlist(watchlist);
        renderConfig(config);
        renderExecutions(executions);
        $('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        $('data-age').textContent = 'Next refresh in 5s';
      } catch (e) {
        console.error('Fetch error:', e);
      }
    }

    // Init
    setWlFilter('all');
    fetchAll();
    setInterval(fetchAll, 5000);
  </script>
</body>
</html>
